<DOCTYPE! html>
<body>
    <head>
        <title>Hello</title>
        <style type="text/css">
            body {
                font-family: sans-serif;
            }
            .info {
                font: 8px serif;
                font-style: italic;
            }
        </style>
    </head>

    <table>
        <tr>
            <td>
                <h1>JS PEW PEW</h1>
                <p>A simple Javascript shooter. Clone me on <a href="https://github.com/Rominer-11/jsPewPew">Github</a>!</p>
                <p class="info">Version Beta 12, Feb 3 2022</p>
            </td>
            <td><canvas id="canvas" width="600px" height="600px" style="border: 2px solid black; margin: 5%;"></canvas></td>
        </tr>
    </table>
    <audio muted="muted"></audio>

    <script>
        var winSound = new Audio('Win.wav');
        var loseSound = new Audio('Lose.wav');
        var playerFireS = new Audio('Fire.wav');
        var enemyFireS = new Audio('Fire.wav');
        const d = new Date();
        const keysPressed = {Left:false, Right:false, Space:false};
        var player = {xPos:290, yPos:550, width:20, height:20};
        var bullet = {xPos:-20, yPos:-20, width:10, height:20};
        var enemyBullet = {xPos:-20, yPos:-20, width:10, height:20};
        var enemy = {xPos:290, yPos:20, width:20, height:20, state:"evading", stateTick:0};
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        var actx = new(window.AudioContext || window.webkitAudioContext)();
        var square = null;
        var fired = false;
        var enemyFired = false;
        var winner = null;
        var iAiStuff = null;
        var iControls = null;
        var iWinCheck = null;
        var iDrawScreen = null;
        var start = false;
    
        d1 = d.getUTCMilliseconds();
        dTime = d.getUTCMilliseconds() - d1;

        ctx.fillStyle = "#000000";
        ctx.font = "20px Arial";
        drawScreen();
        ctx.strokeText("Press any key to start!", 10, 300);

        function startGame() {
            start = true;
            fired = false;
            enemyFired = false;
            winner = null;
            iAiStuff = null;
            iControls = null;
            iWinCheck = null;
            iDrawScreen = null;
            player = {xPos:290, yPos:550, width:20, height:20};
            bullet = {xPos:-20, yPos:-20, width:10, height:20};
            enemyBullet = {xPos:-20, yPos:-20, width:10, height:20};
            enemy = {xPos:290, yPos:20, width:20, height:20, state:"evading", stateTick:0};

            iDrawScreen = setInterval(drawScreen, 10 * dTime);
            iControls = setInterval(controls, 10 * dTime);
            iAiStuff = setInterval(aiStuff, 10 * dTime);
            iWinCheck = setInterval(winCheck, 10 * dTime)
        }

        document.addEventListener('keydown', function(event) {
            if (event.keyCode == 37) {
                keysPressed.Left = true;
            }
            if (event.keyCode == 39) {
                keysPressed.Right = true;
            }
            if (event.keyCode == 32) {
                keysPressed.Space = true;
            }
            if (event.keyCode == 32 && event.target == document.body) {
                event.preventDefault();
            }
        });
        document.addEventListener('keyup', function(event) {
            if (event.keyCode == 37) {
                keysPressed.Left = false;
            }
            if (event.keyCode == 39) {
                keysPressed.Right = false;
            }
            if (event.keyCode == 32) {
                keysPressed.Space = false;
            }
        });

        function soundBank(id) {
            if (id == 0) {
                square = actx.createOscillator();
            }
        }


        function controls() {
            if (keysPressed.Left == true) {
                player.xPos = player.xPos - 2;
            }
            if (keysPressed.Right == true) {
                player.xPos = player.xPos + 2;
            }
            if (keysPressed.Space == true) {
                if (fired == false) {
                    bullet.xPos = player.xPos + (player.width / 4);
                    bullet.yPos = player.yPos - (player.height);
                    console.log("fired");
                    fired = true;
                    playerFireS.play();
                }
            }
            if (fired == true){
                bullet.yPos = bullet.yPos - 4;
                if (bullet.yPos < 0) {
                    fired = false;
                    bullet.xPos = -20;
                    bullet.yPos = -20;
                }
            }
        }

        function moveEnBullet() {    
            if (enemyFired == true) {
                enemyBullet.yPos = enemyBullet.yPos + 4;
                if (enemyBullet.yPos > 600) {
                    enemyFired = false;
                }
            }
        }

        function aiStuff() {
            if (enemy.state == null) {
                enemy.stateTick = 0;
                let x = Math.floor(Math.random() * 3);
                if (x == 0) {
                    console.log("Enemy is thinking");
                    enemy.state = "thinking"
                } else if (x == 1) {
                    console.log("Enemy is attacking");
                    enemy.state = "attacking"
                } else if (x == 2) {
                    console.log("Enemy is evading")
                    enemy.state = "evading"
                }
            }
            if (enemy.state == "thinking") {
                if (enemy.stateTick > 10) {
                    enemy.state = null;
                }
                enemy.stateTick = enemy.stateTick + 1;
            }
            if (enemy.state == "attacking") {
                if (enemy.xPos < player.xPos + 10 && enemy.xPos > player.xPos - 10) {
                    if (enemyFired == false) {
                        enemyBullet.xPos = enemy.xPos + (enemy.width / 4);
                        enemyBullet.yPos = enemy.yPos + (enemy.height);
                        console.log("Enemy Fired");
                        enemyFired = true;
                        enemyFireS.play();
                    }
                }
                if (enemy.xPos > player.xPos) {
                    enemy.xPos = enemy.xPos - 2;
                } else if (enemy.xPos < player.xPos) {
                    enemy.xPos = enemy.xPos + 2;
                }
                if (enemy.stateTick > 500) {
                    enemy.state = null;
                }
                enemy.stateTick = enemy.stateTick + 1;
            }
            if (enemy.state == "evading") {
                if (enemy.xPos < bullet.xPos + 100 && enemy.xPos > bullet.xPos - 100 && bullet.yPos < 100 && bullet.yPos > 0) {
                    if (enemy.xPos > bullet.xPos) {
                        enemy.xPos = enemy.xPos + 2;
                    } else if (enemy.xPos < bullet.xPos) {
                        enemy.xPos = enemy.xPos - 2;
                    }
                }
                if (enemy.stateTick > 150) {
                    enemy.state = null;
                }
                enemy.stateTick = enemy.stateTick + 1;
            }
            moveEnBullet();
        }

        function winCheck() {
            if (bullet.xPos < enemy.xPos + enemy.width && bullet.xPos > enemy.xPos - enemy.width && bullet.yPos < enemy.yPos + enemy.width && fired == true) {
                winner = "player";
                clearInterval(iDrawScreen);
                iDrawScreen = null;
                clearInterval(iControls);
                iControls = null;
                clearInterval(iAiStuff);
                iAiStuff = null;
                clearInterval(iWinCheck);
                iWinCheck = null;
                ctx.fillStyle = "#000000";
                ctx.font = "60px sans-serif";
                drawScreen();
                ctx.strokeText("Player Wins!", 10, 300);
                soundBank(0);
                //winSound.play();
                start = false;
                setTimeout(startGame, 1500);
            } else if (enemyBullet.xPos < player.xPos + player.width && enemyBullet.xPos > player.xPos - player.width && enemyBullet.yPos > player.yPos - player.width && enemyFired == true) {
                winner = "enemy";
                clearInterval(iDrawScreen);
                iDrawScreen = null;
                clearInterval(iControls);
                iControls = null;
                clearInterval(iAiStuff);
                iAiStuff = null;
                clearInterval(iWinCheck);
                iWinCheck = null;
                ctx.fillStyle = "#000000";
                ctx.font = "60px sans-serif";
                drawScreen();
                ctx.strokeText("Enemy Wins!", 10, 300);
                //squareWave.start();
                //setTimeout(() => {squareWave.stop();}, 100)
                loseSound.play();
                start = false;
                setTimeout(startGame, 1500);
            }
        }

        function drawScreen() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#000000";
            ctx.fillRect(player.xPos, player.yPos, player.width, player.height);
            ctx.fillStyle = "#ff0000";
            ctx.fillRect(bullet.xPos, bullet.yPos, bullet.width, bullet.height);
            ctx.fillStyle = "#0000ff";
            ctx.fillRect(enemy.xPos, enemy.yPos, enemy.width, enemy.height);
            ctx.fillStyle = "#ff0000";
            ctx.fillRect(enemyBullet.xPos, enemyBullet.yPos, enemyBullet.width, enemyBullet.height);
        }
        startGame();

    </script>
</body>
